\section{Density functional theory}

\subsection{Functional form of the thermodynamic potentials}

\todo{Insert references to classic texts i.e.\ \cite{EvansAP1979,Evans1989,EvansFoIF1992}}

For inhomogeneous systems the Legendre transform of $\Omega$ \eqref{eq:grand-potential-legendre-transform} generalises to
\begin{equation}
  \Omega = F - \int \rho^{(1)}(\vec{r}) \mu \, d\vec{r}.
\end{equation}
Subtracting external potential contributions from the Helmholtz free energy defines an \emph{intrinsic free energy} containing contributions arising solely from the internal interactions, i.e.\
\begin{equation}\label{eq:intrinsic-free-energy}
  \mathcal{F}
  =
  F - \int \rho^{(1)}(\vec{r}) \phi_\mathrm{ext}(\vec{r}) \, d\vec{r}
\end{equation}
so that the grand potential becomes
\begin{equation}\label{eq:dft-grand-potential}
  \begin{split}
    \Omega
    &=
    \mathcal{F}
    - \int \rho^{(1)}(\vec{r}) (\mu - \phi_\mathrm{ext}(\vec{r})) \, d\vec{r}
    \\ &=
    \mathcal{F}
    - \int \rho^{(1)}(\vec{r}) \psi(\vec{r}) \, d\vec{r}
  \end{split}
\end{equation}
where we defined the \emph{intrinsic chemical potential} $\psi(\vec{r}) = \mu - \phi_\mathrm{ext}(\vec{r})$ in the final step.

Furthermore, the intrinsic free energy can be decomposed into an \emph{ideal} and \emph{excess} part as in
\begin{equation}\label{eq:F-decomposition}
  \mathcal{F}
  =
  \mathcal{F}^\mathrm{id} +
  \mathcal{F}^\mathrm{ex}.
\end{equation}
The excess component emerges as from the interactions between particles and in general it is intractably hard to determine this exactly except in special limits (e.g.\ in the one-dimensional limit).
As such, approximate forms for $\mathcal{F}^\mathrm{ex}$ must be used in general which contrains the success of applications of DFT to the accuracy of this contribution.
By contrast, the ideal component can be computed explicitly.
The partition function for the ideal gas is easily calculated giving
\begin{equation}\label{eq:ideal-grand-canonical-partition}
  \Xi^\mathrm{id}
  =
  \sum_{N=0}^\infty
  \frac{(e^{\beta\mu} Z_1)^N}{N!}
  =
  \exp{\left( \frac{Z_1 e^{\beta \mu}}{\Lambda^d} \right)}.
\end{equation}
Then, following Ref.\ \cite{Ashcroft1996}, we write the equilibrium single-particle density as
\begin{equation*}
  \rho^{(1)}(\vec{r})
  =
  \left\langle
  \sum_{i=1}^N \delta(\vec{r} - \vec{r}_i)
  e^{-\beta \phi_\mathrm{ext}(\vec{r})}
  \right\rangle
\end{equation*}
which in the absence of particle interactions reduces to
\begin{equation}\label{eq:ideal-density}
  \rho^{(1)}(\vec{r})
  =
  \frac{
    \langle N \rangle e^{-\beta \phi_\mathrm{ext}(\vec{r})}
  }{
    \int e^{-\beta \phi_\mathrm{ext}(\vec{r}')} \, d\vec{r}'
  }
  =
  \frac{e^{-\beta (\mu - \phi_\mathrm{ext}(\vec{r}))}}{\Lambda^d}.
\end{equation}
We can express the grand potential for the non-interacting system as a functional of the external potential from the partition function \eqref{eq:ideal-grand-canonical-partition} as
\begin{equation*}
  \beta\Omega^\mathrm{id}
  =
  - \ln{\Xi^\mathrm{id}}
  =
  - \int \frac{e^{-\beta (\phi_\mathrm{ext}(\vec{r}) - \mu)}}{\Lambda^d} d\vec{r}
\end{equation*}
or in its dual form as a functional of density \eqref{eq:dft-grand-potential} as
\begin{equation*}
  \beta\Omega^\mathrm{id}
  =
  \beta \mathcal{F}^\mathrm{id}
  - \int \rho^{(1)}(\vec{r}) \beta \psi(\vec{r}) \, d\vec{r}.
\end{equation*}
Equating these two forms and rearranging we find the ideal part of the Helmholtz free energy as
\begin{align}\
  \beta \mathcal{F}^\mathrm{id}
  &=
  \int
  \left(
  \rho^{(1)}(\vec{r}) \beta (\phi_\mathrm{ext}(\vec{r}) - \mu)
  - \frac{e^{-\beta (\phi_\mathrm{ext}(\vec{r}) - \mu)}}{\Lambda^d}
  \right)
  \, d\vec{r}
  \nonumber \\ &=
  \int
  \rho^{(1)}(\vec{r})
  \left(
  \ln{(\Lambda^d \rho^{(1)}(\vec{r}))} - 1
  \right)
  \, d\vec{r}
  \label{eq:ideal-free-energy-functional}
\end{align}
using the ideal density \eqref{eq:ideal-density} in the final step.
The inhomogeneous ideal gas free energy density is thus identical to the homogeneous case \eqref{eq:ideal-free-energy-density} after replacing the global density with a local one.

\subsection{Thermodynamic potentials as generating functionals}

The fundamental thermodynamic relation describing an infinitesimal change in the Helmholtz free energy, i.e.\
\begin{equation*}
  dF = -S dT - p dV + \mu dN,
\end{equation*}
generalises to an inhomogeneous system as
\begin{equation*}
  \begin{split}
    \delta F
    =
    - S \delta T
    + \int \rho^{(1)}(\vec{r}) \delta \phi_\mathrm{ext}(\vec{r}) \, d\vec{r}
    + \int \mu \delta \rho^{(1)}(\vec{r}) \, d\vec{r}
  \end{split}
\end{equation*}
The change in the intrinsic free energy is then
\begin{equation}\label{eq:infinitesimal-free-energy}
  \begin{split}
    \delta \mathcal{F}
    &=
    \delta F
    - \int \delta \rho^{(1)}(\vec{r}) \phi_\mathrm{ext}(\vec{r}) \, d\vec{r}
    - \int \rho^{(1)}(\vec{r}) \delta \phi_\mathrm{ext}(\vec{r}) \, d\vec{r}
    \\ &=
    - S \delta T
    + \int \delta \rho^{(1)}(\vec{r}) \psi(\vec{r}) \, d\vec{r}.
  \end{split}
\end{equation}
By similar steps, or using the Legendre transform of the grand potential \eqref{eq:grand-potential-legendre-transform}, it follows that
\begin{equation}\label{eq:infinitesimal-grand-potential}
  \delta \Omega
  =
  - S \delta T
  - \int \rho^{(1)}(\vec{r}) \delta \psi(\vec{r}) \, d\vec{r}
\end{equation}
Hence, from functional differentiation of \eqref{eq:infinitesimal-free-energy} and \eqref{eq:infinitesimal-grand-potential} it follows that
\begin{align}
  \label{eq:psi-generator}
  \frac{\delta \mathcal{F}}{\delta \rho^{(1)}(\vec{r})}
  &=
  \psi(\vec{r})
  \\
  \label{eq:rho-generator}
  \frac{\delta \Omega}{\delta \psi(\vec{r})}
  &=
  - \rho^{(1)}(\vec{r})
\end{align}
i.e.\ the intrinsic free energy and grand potentials act as \emph{generating functionals} for the intrinsic chemical potential and density respectively.

Repeated functional differentiation of the thermodynamic potentials produces a whole hierarchy of correlation functions.
The hierarchy obtained from the grand potential is the density-density correlations which we already introduced in \eqref{eq:density-density-correlations};
these are generated by the grand potential as \cite{Hansen2013}
\begin{equation}\label{eq:density-density-generator}
  H^{(n)}(\vec{r}^n)
  =
  - \frac{
    \delta^n \beta \Omega
  }{
    \delta \beta\psi(\vec{r}_1) \cdots \delta \beta\psi(\vec{r}_n)
  }
  =
  \frac{
    \delta^{n-1} \rho^{(1)}(\vec{r}_1)
  }{
    \delta \beta\psi(\vec{r}_2) \cdots \delta \beta\psi(\vec{r}_n)
  }.
\end{equation}
The intrinsic free energy also generates a new hierarchy of correlation functions, however the contribution from the ideal part is not especially interesting.
We thus define the \emph{direct correlation functions} as the hierarchy generated from the excess part as
\begin{equation}\label{eq:direct-correlations}
  c^{(n)}(\vec{r}^n)
  =
  - \frac{
    \delta^n \beta \mathcal{F}^\mathrm{ex}
  }{
    \delta \rho^{(1)}(\vec{r}_1) \cdots \delta \rho^{(1)}(\vec{r}_n)
  }.
\end{equation}
These correlation functions form the basis of integral equation theories which we will outline in the next section.

\subsection{Integral equation theories}
\label{sec:oz-equation}

In this section we derive the Ornstein-Zernike equation which forms the basis of many theories of the liquid state%
\marginfootnote{Conventionally this is class of theories are presented in their own right rather than as a special case of density functional theory; we have opted for this more modern presentation to be economical with chapter length.}.
This is an integral equation which connects the density-density and direct correlation functions through the chain rule of functional calculus, i.e.\
\begin{equation}\label{eq:oz-chain-rule}
  \delta(\vec{r}_1 - \vec{r}_2) =
  \int
  \frac{\delta \rho^{(1)}(\vec{r}_1)}{\delta \beta\psi(\vec{r}')}
  \frac{\delta \beta\psi(\vec{r}')}{\delta \rho^{(1)}(\vec{r}_2)}
  \, d\vec{r}'.
\end{equation}
The first term appearing in the integrand is simply the pair density-density correlation function $H^{(2)}$ via \eqref{eq:density-density-generator},
so we will require an explicit expression for the second term to proceed.

The first functional derivative of the ideal intrinsic free energy \eqref{eq:ideal-free-energy-functional} yields
\begin{equation*}
  \frac{
    \delta \beta \mathcal{F}^\mathrm{id}
  }{
    \delta \rho^{(1)}(\vec{r})
  }
  =
  \ln{(\Lambda^d \rho^{(1)}(\vec{r}))}.
\end{equation*}
To obtain the higher order functional derivatives it is helpful to write this as an integral with a delta function
\begin{equation*}
  \frac{
    \delta \beta \mathcal{F}^\mathrm{id}
  }{
    \delta \rho^{(1)}(\vec{r})
  }
  =
  \int \delta{(\vec{r}' - \vec{r})}
  \ln{(\Lambda^d \rho^{(1)}(\vec{r}'))} \, d\vec{r}',
\end{equation*}
so we can obtain the second derivative as
\begin{equation*}
  \frac{
    \delta^2 \beta \mathcal{F}^\mathrm{id}
  }{
    \delta \rho^{(1)}(\vec{r}) \delta \rho^{(1)}(\vec{r}')
  }
  =
  \frac{\delta(\vec{r}'-\vec{r})}{\rho^{(1)}(\vec{r})}.
\end{equation*}
%% Iterating this procedure gives us the $n$th functional derivative as
%% \begin{equation}
%%   \begin{split}
%%     \frac{
%%       \delta^n \beta \mathcal{F}^\mathrm{id}
%%     }{
%%       \delta \rho^{(1)}(\vec{r}_1) \cdots \delta \rho^{(1)}(\vec{r}_n)
%%     }
%%     &=
%%     \frac{
%%       \partial^{n-1} (\ln{(\Lambda^d \rho^{(1)}(\vec{r}))})
%%     }{
%%       \partial \rho^{(1)}(\vec{r})^{n-1}
%%     }
%%     \prod_{i=2}^n \delta(\vec{r}_i - \vec{r}_1)
%%     \\ &=
%%     (-1)^{n-1}
%%     \frac{(n-2)!}{\rho^{(1)}(\vec{r})^{n-1}}
%%     \prod_{i=2}^n \delta(\vec{r}_i - \vec{r}_1),
%%   \end{split}
%% \end{equation}
%% where the last line is valid for all $n \ge 2$.
From the free energy as a generating functional \eqref{eq:psi-generator} and the decomposition of the free energy into ideal and excess parts \eqref{eq:F-decomposition} it follows that
\begin{equation*}
  \begin{split}
    \beta \psi(\vec{r})
    =
    \frac{\delta \beta \mathcal{F}}{\delta \rho^{(1)}(\vec{r})}
    &=
    \frac{\delta \beta \mathcal{F}^\mathrm{id}}{\delta \rho^{(1)}(\vec{r})}
    + \frac{\delta \beta \mathcal{F}^\mathrm{ex}}{\delta \rho^{(1)}(\vec{r})}
    \\
    &=
    \ln{(\Lambda^d \rho^{(1)}(\vec{r}))} - c^{(1)}(\vec{r}),
  \end{split}
\end{equation*}
using the definition of the direct correlation function \eqref{eq:direct-correlations} in the latter step.
Further functional differentiation yields
\begin{equation*}\label{eq:intrinsic-chemical-potential-inverse-derivative}
  \frac{\delta \beta \psi(\vec{r})}{\delta \rho^{(1)}(\vec{r}')}
  =
  \frac{\delta(\vec{r} - \vec{r}')}{\rho^{(1)}(\vec{r}')}
  - c^{(2)}(\vec{r}, \vec{r}').
\end{equation*}
Inserting this expression into \eqref{eq:oz-chain-rule} gives
\begin{equation*}
  \begin{split}
    \delta(\vec{r}_1 - \vec{r}_2)
    &=
    \int
    H^{(2)}(\vec{r}_1, \vec{r}')
    \left(
    \frac{\delta(\vec{r}' - \vec{r}_2)}{\rho^{(1)}(\vec{r}')} -
    c^{(2)}(\vec{r}', \vec{r}_2)
    \right)
    \, d\vec{r}'
    %% \\ &=
    %% \rho^{(1)}(\vec{r}_1)
    %% \left(
    %% h^{(2)}(\vec{r}_1, \vec{r}_2) -
    %% c^{(2)}(\vec{r}_1, \vec{r}_2)
    %% \right) +
    %% \delta(\vec{r}_1 - \vec{r}_2) -
    %% \\ &\qquad
    %% \rho^{(1)}(\vec{r}_1)
    %% \int
    %% \rho^{(1)}(\vec{r}')
    %% h^{(2)}(\vec{r}_1, \vec{r}')
    %% c^{(2)}(\vec{r}', \vec{r}_2)
    %% \, d\vec{r}'
  \end{split}
\end{equation*}
which rearranges to give the Ornstein-Zernike equation
\begin{equation}\label{eq:ornstein-zernike-generic}
  h^{(2)}(\vec{r}_1, \vec{r}_2) =
  c^{(2)}(\vec{r}_1, \vec{r}_2) +
  \int
  \rho^{(1)}(\vec{r}')
  h^{(2)}(\vec{r}_1, \vec{r}')
  c^{(2)}(\vec{r}', \vec{r}_2)
  \, d\vec{r}',
\end{equation}
which is a classic result of liquid state theory (cf.\ Refs.\ \cite{OrnsteinPAS1914,Hansen2013,EvansAP1979}).

For a uniform liquid interacting through a spherically symmetric pair potential the Ornstein-Zernike equation becomes
\begin{equation}\label{eq:ornstein-zernike-spherical}
  \begin{split}
    h^{(2)}(r)
    &=
    c^{(2)}(r) +
    \rho
    \int
    h^{(2)}(r)
    c^{(2)}(|\vec{r}' - \vec{r}|)
    \, d\vec{r}'
    \\ &=
    c^{(2)}(r) + \rho \, (h^{(2)} * c^{(2)})(r),
  \end{split}
\end{equation}
where $r = |\vec{r}_2 - \vec{r}_1|$ and $(f*g)(\vec{r})$ denotes a convolution between functions $f$ and $g$.
In Fourier space the convolution becomes a product so we obtain
\begin{equation*}
  \tilde{h}^{(2)}(\vec{k})
  =
  \tilde{c}^{(2)}(\vec{k}) +
  \rho \, \tilde{h}^{(2)}(\vec{k}) \tilde{c}^{(2)}(\vec{k})
\end{equation*}
where the tildes over a function denotes its Fourier transform.
This rearranges to give
\begin{equation*}
  \tilde{h}^{(2)}(\vec{k})
  =
  \frac{\tilde{c}^{(2)}(\vec{k})}{1 - \rho \tilde{c}^{(2)}(\vec{k})}
\end{equation*}
which gives the static structure factor \eqref{eq:static-structure-factor} as
\begin{equation*}
  S^{(2)}(\vec{k})
  =
  \rho \delta(\vec{k}) +
  \frac{1}{1 - \rho \tilde{c}^{(2)}(\vec{k})}.
\end{equation*}
If the pair direct correlation function is known it is thus straightforward to obtain the equation of state through the compressibility route \eqref{eq:compressibility-route-pressure}
\begin{equation*}
  \frac{\beta p}{\rho}
  =
  1 - \frac{1}{\rho} \int_0^\rho \tilde{c}^{(2)}(0) \rho' d\rho'.
\end{equation*}

The main task of integral equation approaches is to find approximate closures for $c^{(2)}$ and then solve the Ornstein-Zernike equation.
The process of determining the direct correlation functions is equivalent (at least formally) to finding its generating functional $\mathcal{F}^\mathrm{ex}$.

%% \subsection{Generalised Ornstein-Zernike equations}

%% This section follows \cite{BarratMP1988}.\todo{Check this reference and rewrite accordingly}

%% Thus for higher $n$ we have
%% \begin{equation}
%%   \begin{split}
%%     c^{(n)}(\vec{r}^n)
%%     &=
%%     \frac{
%%       \delta^{n-1} c^{(1)}(\vec{r}_1)
%%     }{
%%       \delta \rho^{(1)}(\vec{r}_2) \cdots \delta \rho^{(1)}(\vec{r}_n)
%%     }
%%     \\ &=
%%     (-1)^n
%%     \frac{(n-2)!}{\rho^{(1)}(\vec{r}_1)^{n-1}}
%%     \prod_{i=2}^n \delta(\vec{r}_i - \vec{r}_1)
%%     - \frac{
%%       \delta^{n-1} \beta\psi(\vec{r}_1)
%%     }{
%%       \delta \rho^{(1)}(\vec{r}_2) \cdots \delta \rho^{(1)}(\vec{r}_n)
%%     }
%%   \end{split}
%% \end{equation}
%% or
%% \begin{equation}
%%   \frac{\delta^{n-1} \beta\psi(\vec{r}_1)}{\delta \rho^{(1)}(\vec{r}_2) \cdots \delta \rho^{(1)}(\vec{r}_n)}
%%   =
%%   (-1)^n
%%   \frac{(n-2)!}{\rho^{(1)}(\vec{r}_1)^{n-1}}
%%   \prod_{i=2}^n \delta(\vec{r}_i - \vec{r}_1)
%%   - c^{(n)}(\vec{r}^n)
%% \end{equation}

%% \begin{equation*}
%%   H^{(n)}(\vec{r}^n)
%%   =
%%   \frac{
%%     \delta^{n-1} \rho^{(1)}(\vec{r}_1)
%%   }{
%%     \delta \beta\psi(\vec{r}_2) \cdots \delta \beta\psi(\vec{r}_n)
%%   }.
%% \end{equation*}

%% Defining
%% \begin{equation*}
%%   K^{(n)}(\vec{r}^n)
%%   =
%%   \frac{
%%     \delta^{n-1} \beta\psi(\vec{r}_1)
%%   }{
%%     \delta \rho^{(1)}(\vec{r}_2) \cdots \delta \rho^{(1)}(\vec{r}_n)
%%   }
%% \end{equation*}
%% we have
%% \begin{equation*}
%%   \frac{
%%     \delta K^{(n)}(\vec{r}^n)
%%   }{
%%     \delta \rho^{(1)}(\vec{r}_{n+1})
%%   }
%%   =
%%   K^{(n+1)}(\vec{r}^{n+1}).
%% \end{equation*}
%% and
%% \begin{equation*}
%%   \begin{split}
%%     \frac{\delta H^{(n)}(\vec{r}^n)}{\delta \rho^{(1)}(\vec{r}_{n+1})}
%%     &=
%%     \int
%%     \frac{\delta H^{(n)}(\vec{r}^n)}{\delta \psi(\vec{r}')}
%%     \frac{\delta \psi(\vec{r}')}{\delta \rho^{(1)}(\vec{r}_{n+1})}
%%     \, d\vec{r}' \\
%%     &=
%%     \int
%%     H^{(n+1)}(\vec{r}^n, \vec{r}')
%%     K^{(2)}(\vec{r}', \vec{r}_{n+1})
%%     \, d\vec{r}' \\
%%     &=
%%     H^{(n+1)} * K^{(2)}(\vec{r}^{n+1}).
%%   \end{split}
%% \end{equation*}
%% In this form the Ornstein-Zernike equation can be written.
%% \begin{equation*}
%%   \begin{split}
%%     \delta(\vec{r}_1 - \vec{r}_2)
%%     &=
%%     \int
%%     \frac{\delta \rho^{(1)}(\vec{r}_1)}{\delta \psi(\vec{r}')}
%%     \frac{\delta \psi(\vec{r}')}{\delta \rho^{(1)}(\vec{r}_2)}
%%     \, d\vec{r}' \\
%%     &=
%%     \int
%%     H^{(2)}(\vec{r}_1, \vec{r}') K^{(2)}(\vec{r}', \vec{r}_2)
%%     \, d\vec{r}' \\
%%     &=
%%     H^{(2)} * K^{(2)} (\vec{r}^2)
%%   \end{split}
%% \end{equation*}
%% Taking functional derivatives of this expression gives us a hierarchy of generalised Ornstein-Zernike equations.
%% For example, the next equation in the hierarchy is
%% \begin{equation*}
%%   H^{(2)} * K^{(3)} (\vec{r}^3) +
%%   H^{(3)} * K^{(2)} * K^{(2)} (\vec{r}^3)
%%   = 0
%% \end{equation*}
%% The next functional derivative
%% \begin{equation}
%%   \begin{split}
%%   H^{(2)} * K^{(4)} (\vec{r}^4) & \\
%%   + \; 3 H^{(3)} * K^{(3)} * K^{(2)} (\vec{r}^4) & \\
%%   + \; H^{(4)} * K^{(2)} * K^{(2)} * K^{(2)} (\vec{r}^4)
%%   &= 0
%%   \end{split}
%% \end{equation}
%% And the next one%
%% \todo{Can we find a general formula? I notice some constraints on the indices: the sum of the indices $\{m\}$ in the $K^{(m)}$ terms must add up to $n-1$ so that the right number of independent variables are returned (the extra one is provided by the $H^{(l)}$ function giving the $\vec{r}^n$ total.)}
%% \begin{equation}
%%   \begin{split}
%%     H^{(2)} * K^{(5)} (\vec{r}^5) & \\
%%     + \; 3 H^{(3)} * K^{(3)} * K^{(3)} (\vec{r}^5) & \\
%%     + \; 4 H^{(3)} * K^{(4)} * K^{(2)} (\vec{r}^5) & \\
%%     + \; 6 H^{(4)} * K^{(3)} * K^{(2)} * K^{(2)} (\vec{r}^5) & \\
%%     + \; H^{(5)} * K^{(2)} * K^{(2)} * K^{(2)} * K^{(2)} (\vec{r}^5)
%%     &=
%%     0
%%   \end{split}
%% \end{equation}

\subsection{Fundamental measure theory}
\label{sec:fmt}

\todo{Finish this section}
FMT: a recent review \cite{RothJPCM2010}.
Also mention \cite{LutskoAiCP2010} for more of a focus on crystallisation.
This exposition follows \cite{RothJPCM2010} mainly.

%\subsection{Many-body correlations from fundamental measure theory}

\begin{itemize}
\item $d+1$ weight functions
\end{itemize}

%Rosenfeld started from the observation that
The purely geometric character of the hard sphere interaction leads to the \emph{exact} decomposition of Mayer-$f$ bond in terms of intrinsic volumes%
\marginfootnote{Rosenfeld called these \emph{fundamental measures} giving the theory its name.}
\begin{equation*}
  \begin{split}
    -f_{ij}(\vec{r})
    =&
    \Theta(R_i + R_j - |\vec{r}|)
    \\ =& \quad\,
    \omega_i^{(0)} \otimes \omega_j^{(3)}
    + \omega_i^{(1)} \otimes \omega_j^{(2)}
    + \omega_i^{(2)} \otimes \omega_j^{(1)}
    + \omega_i^{(3)} \otimes \omega_j^{(0)}
    \\ &
    - \omega_i^{(1)} \otimes \omega_j^{(2)}
    - \omega_i^{(2)} \otimes \omega_j^{(1)}
  \end{split}
\end{equation*}
introducing the weight functions
\begin{subequations}
  \begin{align}
    \omega_3^i(\vec{r})
    &=
    \Theta(R_i - r), \\
    \omega_2^i(\vec{r})
    &=
    \delta(R_i - r), \\
    \omega_1^i(\vec{r})
    &=
    \frac{\omega_2^i(\vec{r})}{4\pi R_i}, \\
    \omega_0^i(\vec{r})
    &=
    \frac{\omega_2^i(\vec{r})}{4\pi R_i^2},
    \\
    \vec{\omega}_2^i(\vec{r})
    &=
    \frac{\vec{r}}{r} \delta(R_i - r),
    \\
    \vec{\omega}_1^i(\vec{r})
    &=
    \frac{\vec{\omega}_1^i(\vec{r})}{4\pi R_i}.
  \end{align}
\end{subequations}
The appearance of the weight functions inside the free energy \eqref{?} through the Mayer-$f$ function naturally leads to convolutions with the density.
This gives rise to a set of \emph{weighted densities} $\{n_\alpha(\vec{r})\}$ defined as \cite{RosenfeldPRL1989,PercusJSP1988}
\begin{equation}
  n_\alpha(\vec{r})
  =
  \sum_{i=1}^m \int
  \rho_i(\vec{r}') \omega_\alpha^i(\vec{r} - \vec{r'})
  \, d\vec{r}'
\end{equation}
where we use the shorthand where $\alpha$ indexes both the scalar and vector weight functions.
The low density excess free energy becomes a local function of the (nonlocal) weighted densities, as in
\begin{equation*}
  \begin{split}
    \beta \mathcal{F}^\mathrm{ex}[\{\rho_i\}]
    &=
    - \frac{1}{2} \sum_{i,j} \int \int
    \rho_i(\vec{r}) \rho_j(\vec{r}') f_{ij}(\vec{r} - \vec{r}')
    \, d\vec{r} d\vec{r}'
    + \mathcal{O}(\rho^2),
    \\ &=
    \int \Big(
    n_0(\vec{r}) n_3(\vec{r})
    + n_1(\vec{r}) n_2(\vec{r})
    - \vec{n}_1(\vec{r}) \vec{n}_2(\vec{r})
    \Big) d\vec{r}
    + \mathcal{O}(\rho^2).
  \end{split}
\end{equation*}
A second advantage is that all of the molarity information is absorbed into the definition of the weighted densities so the final form contains no explicit mixture dependence.
The central simplifying assumption of fundamental measure theory (FMT) is to assume that the excess free energy remains a function only of $\{n_\alpha\}$

\todo{Truncatable free energies.}
Thermodynamic consistency of the (osmotic) pressure:
\begin{equation}
  \begin{split}
    \beta p
    &=
    \rho - \frac{\beta F^\mathrm{ex}}{V}
    + \rho \frac{\partial}{\partial \rho}
    \left( \frac{\beta F^\mathrm{ex}}{V} \right)_{V,T}
    \\ &=
    \rho - \beta \Phi^\mathrm{ex}
    + \rho \left( \frac{\partial \beta \Phi^\mathrm{ex}}{\partial \rho} \right)_{V,T}
  \end{split}
\end{equation}
where $\Phi^\mathrm{ex} = F^\mathrm{ex}/V$ is the (excess) free energy density.

Chemical potential of species $i$
\begin{equation}
  \beta \mu_i^\mathrm{ex}
  =
  \frac{\partial}{\partial \rho_i}
  \left( \frac{ \beta F^\mathrm{ex} }{V} \right)_{V,T}
\end{equation}
In the large particle limit the chemical potential is simply the work required to create a cavity large enough to contain the particle%
\marginfootnote{We will formally derive this property in the context of many-body correlations in section \ref{sec:many-body-correlations}.},
i.e.\ \cite{RothJPCM2002,ReissJCP1960}
\begin{equation}
  \lim_{V_i \to \infty} \frac{\beta \mu_i^\mathrm{ex}}{V_i} = \beta p.
\end{equation}
For concentration dependence entering through a finite set of weight functions we have
\begin{equation*}
  \frac{\partial}{\partial \rho_i}
  =
  \sum_\alpha
  \frac{\partial n_\alpha}{\partial \rho_i}
  \frac{\partial}{\partial n_\alpha}
\end{equation*}
The explicit differentials give
\begin{subequations}
  \begin{align}
    \frac{\partial n_3}{\partial \rho_i}
    &=
    \frac{4 \pi R_i^3}{3}
    \\
    \frac{\partial n_2}{\partial \rho_i}
    &=
    4 \pi R_i^2
    \\
    \frac{\partial n_1}{\partial \rho_i}
    &=
    R_i
    \\
    \frac{\partial n_0}{\partial \rho_i}
    &=
    1
  \end{align}
\end{subequations}
and similar expressions for the vectorial terms.
In the large volume limit the $n_3$ term dominates leading to
\begin{equation*}
  \lim_{V_i \to \infty}
  \frac{\partial}{\partial \rho_i}
  =
  V_i \frac{\partial}{\partial n_3}
\end{equation*}
so it follows that
\begin{equation}\label{eq:fmt-pressure}
  \beta p
  =
  \frac{\partial \beta \Phi{ex} }{\partial n_3}.
\end{equation}
\todo{This part is a bit bare: let's flesh it out a little more.}
Secondly, we find the derivative with respect to density reduces to
\begin{equation*}
  \frac{\partial}{\partial \rho}
  =
  \sum_i
  \frac{\partial \rho_i}{\partial \rho}
  \frac{\partial}{\partial \rho_i}
  =
  \frac{1}{\rho}
  \sum_\alpha
  n_\alpha
  \frac{\partial}{\partial n_\alpha}
\end{equation*}
Leads to the scaled particle%
\marginfootnote{We will leave discussion of scaled particle theory until Chapter  \ref{chapter:morphometric-framework} where we describe it in detail.}
differential equation
\begin{equation}\label{eq:fmt-spt-pde}
  (1 - n_3) \frac{\partial \Phi^\mathrm{ex}}{\partial n_3}
  =
  n_0 - \Phi
  + \sum_{\alpha = 0}^2
  n_\alpha \frac{\partial \Phi^\mathrm{ex}}{\partial n_\alpha}
\end{equation}
In Refs.\ \cite{SantosJCP2012,SantosPRE2012} it was shown that the solution to \eqref{eq:fmt-spt-pde} which correctly recovers the low density behaviour and maximises self-consistency for mixtures must have the generic form
\begin{equation}
  \beta \Phi^\mathrm{ex}(\Psi)
  =
  \beta \Phi^\mathrm{ex}_1 + \beta \Phi^\mathrm{ex}_2 + \beta \Phi^\mathrm{ex}_3
  + \beta \Phi^\mathrm{ex}_2 \Psi\left(\frac{2 \Phi^\mathrm{ex}_3}{\Phi^\mathrm{ex}_2}\right),
\end{equation}
with
\begin{subequations}
  \begin{align}
    \beta \Phi^\mathrm{ex}_1
    &=
    - n_0 \ln{(1 - n_3)}
    \\
    \beta \Phi^\mathrm{ex}_2
    &=
    \frac{n_1 n_2 - \vec{n}_1 \cdot \vec{n}_2}{1 - n_3}
    \\
    \beta \Phi^\mathrm{ex}_3
    &=
    \frac{n_2^3 - 3 n_2 \, \vec{n}_2 \cdot \vec{n}_2}{24 \pi (1 - n_3)^2}
  \end{align}
\end{subequations}
This defines a whole class of self-consistent free energy functionals which differ only by the choice of the function $\Psi$ which corresponds to fixing the free energy density of the bulk liquid.
The simplest functional in this class is the Rosenfeld (RF) functional which takes $\Psi(\cdot) = 0$.
Written explicitly the resulting free energy density is then \cite{RosenfeldPRL1989}
\begin{equation}\label{eq:rosenfeld-functional}
  \beta \Phi_\mathrm{RF}^\mathrm{ex}
  =
  - n_0 \ln{(1 - n_3)}
  + \frac{n_1 n_2 - \vec{n}_1 \cdot \vec{n}_2}{1 - n_3}
  + \frac{n_2^3 - 3 n_2 \vec{n}_2 \cdot \vec{n}_2}{24 \pi (1 - n_3)^2}.
\end{equation}

From their definition as functional derivatives of the excess free energy \eqref{eq:direct-correlations}, we find that direct correlation functions for FMT functionals must generically adopt the form of \cite{RosenfeldPRL1989}
\begin{equation}\label{eq:fmt-direct-correlations}
  c^{(n)}(\vec{r}^n; \Phi^\mathrm{ex})
  =
  - \sum_{\alpha_1, \cdots, \alpha_n}
  \int d\vec{r}'
  \prod_{i=1}^n \Big( \omega_{\alpha_i}(\vec{r}' - \vec{r}_i) \Big)
  \partial^n_{\alpha_1, \cdots, \alpha_n} \beta \Phi^\mathrm{ex}(\vec{r}')
\end{equation}
where we use the shorthand 
\begin{equation*}
  \partial^n_{\alpha_1, \cdots, \alpha_n} \beta \Phi^\mathrm{ex}(\vec{r}) =
  \left.
  \frac{\partial^n \beta \Phi^\mathrm{ex}}{\partial n_{\alpha_1} \cdots \partial n_{\alpha_n}}
  \right|_{\{n_\alpha\} = \{n_\alpha(\vec{r})\}}.
\end{equation*}
At uniform density $\partial^n_{\alpha_1, \cdots, \alpha_n} \beta \Phi^\mathrm{ex}$ is position independent, so we define
\begin{equation}
  \chi_{\alpha_1, \cdots, \alpha_n}(\Phi^\mathrm{ex})
  =
  \left.
  \frac{\partial^n \beta \Phi^\mathrm{ex}}{\partial n_{\alpha_1} \cdots \partial n_{\alpha_n}}
  \right|_{\{n_\alpha(\vec{r})\} = \{\xi_\alpha\}}
\end{equation}
and then the direct correlation functions \eqref{eq:fmt-direct-correlations} for the uniform liquid become \cite{RosenfeldJCP1990}
\begin{equation}\label{eq:fmt-direct-correlations-uniform-density}
  \begin{split}
    c^{(n)}(\vec{r}^n; \Phi^\mathrm{ex})
    &=
    - \sum_{\alpha_1, \cdots, \alpha_n}
    \chi_{\alpha_1, \cdots, \alpha_n}(\Phi^\mathrm{ex})
    \int d\vec{r}'
    \prod_{i=1}^n \Big( \omega_{\alpha_i}(\vec{r}' - \vec{r}_i) \Big)
    \\ &=
    - \sum_{\alpha_1, \cdots, \alpha_n}
    \chi_{\alpha_1, \cdots, \alpha_n}(\Phi^\mathrm{ex}) \;
    (\omega_{\alpha_1} \otimes \cdots \otimes \omega_{\alpha_n})
    (\vec{r}^n)
  \end{split}
\end{equation}

\begin{tcolorbox}[title=Percus-Yevick theory in hard spheres]
  Using \eqref{eq:fmt-direct-correlations-uniform-density} the second functional derivative of the Rosenfeld free energy density \eqref{eq:rosenfeld-functional} for the single-component system $R_i + R_j = 2R = \sigma$ yields the Percus-Yevick direct correlation function \cite{RosenfeldJCP1988,WertheimPRL1963}
  \begin{align}
    c^{(2)}_\mathrm{PY}(r)
    =
    - \frac{\delta^2 \Phi_\mathrm{RF}^\mathrm{ex}}{\delta \rho(\vec{r}) \delta \rho(\vec{r}')}
    =&
    - \chi_{3,3}(\Phi_\mathrm{RF}^\mathrm{ex}) \Delta V(r)
    - \chi_{3,2}(\Phi_\mathrm{RF}^\mathrm{ex}) \Delta A(r)
    \nonumber \\ &
    - \chi_{3,1}(\Phi_\mathrm{RF}^\mathrm{ex}) \Delta L(r)
    %- \chi_{3,0}(\Phi_\mathrm{RF}^\mathrm{ex}) \Theta((R_i - R_j) - r)
  \end{align}
  where $\Delta V, \Delta A, \Delta L$ are the intrinsic volumes for the region where the two spheres overlap.
  With an exact form of the direct correlation function it is straightforward to determine the pair distribution function $g^{(2)}(r)$ from solving the Ornstein-Zernike equation \eqref{eq:ornstein-zernike-spherical}.
  The equation of state can then be determined through the virial route \eqref{eq:virial-route-pressure} giving
  \begin{equation}
    \frac{\beta p^\mathrm{PY-V}}{\rho}
    =
    \frac{1 + \eta + \eta^2 - 3\eta^3}{(1 - \eta)^3},
  \end{equation}
  or through the compressibility route \eqref{eq:compressibility-route-pressure} giving
  \begin{equation}\label{eq:pyc-pressure}
    \frac{\beta p^\mathrm{PY-C}}{\rho}
    =
    \frac{1 + \eta + \eta^2}{(1 - \eta)^3}.
  \end{equation}
  The latter route is more accurate and also consistent with the pressure of the Rosenfeld functional \eqref{eq:rosenfeld-functional} through \eqref{eq:fmt-pressure} and the scaled particle differential equation%
  \marginfootnote{in Chapter \ref{chapter:morphometric-framework} we will refer to this as the scaled particle theory/Percus-Yevick (SPT/PY) equation of state because of this correpondence.}
  \eqref{eq:fmt-spt-pde}.

  Curiously, an empirical interpolation between the two solutions of the Percus-Yevick theory yields the highly accurate Carnahan-Starling (CS) equation of state \cite{CarnahanJCP1969}
  \begin{equation}\label{eq:cs-pressure}
    \begin{split}
      \frac{\beta p^\mathrm{CS}}{\rho}
      &=
      \frac{1}{3} \frac{\beta p^\mathrm{PY-V}}{\rho}
      + \frac{2}{3} \frac{\beta p^\mathrm{PY-C}}{\rho}
      \\ &=
      \frac{1 + \eta + \eta^2 - \eta^3}{(1-\eta)^3}.
    \end{split}
  \end{equation}
  We will assume this equation of state to construct accurate theories of correlations in the hard sphere liquid in the later chapters.
\end{tcolorbox}

Taking the Carnahan-Starling White bear II:
\begin{equation}
  c^{(2)}(r)
\end{equation}
\todo{Check mixture version of CS from Santos, and compare with Berthier. Cite Berthier for accuracy.}

\subsection{FMT Structure factors}

Applying the convolution theorem allows the Fourier transform of \eqref{eq:fmt-direct-correlations-uniform-density} to be written rather succinctly as
\begin{equation}
  \tilde{c}^{(n)}(\vec{k}^n) =
  - \sum_{\alpha_1, \alpha_2, \cdots, \alpha_n}
  \partial^n_{\alpha_1, \alpha_2, \cdots, \alpha_n} \beta\Phi_{ex} \;
  \left( \prod_{i=1}^n \widetilde{\omega}_{\alpha_i}(\vec{k}_i) \right)
  \delta(\vec{k}_1 + \vec{k}_2 + \cdots + \vec{k}_n).
\end{equation}
The delta function enforces the `ring' condition $\sum_{i=1}^n \vec{k}_i = 0$ which emerges from translational symmetry of the weight functions, reducing the dimensionality of the domain by $d$.
A further $d(d-1)/2$ degrees of freedom%
\marginfootnote{This many degrees of freedom can be removed for general $n \ge d$, but we expect fewer for $n < d$.
  For example, $n=2$ arrangements (a dimer) are isomorphic to a line so they possess $d-1$ rotational degrees of freedom.}
can be removed by exploiting rotational symmetry.

%% \begin{SCfigure}[H]
%%   \missingfigure[figwidth=\linewidth]{}
%%   \caption{Static structure factor for convolution, Rosenfeld and White Bear closures.}
%% \end{SCfigure}

%% \begin{SCfigure}[H]
%%   \missingfigure[figwidth=\linewidth]{}
%%   \caption{Triplet static structure factors for convolution, Rosenfeld and White Bear closures.}
%% \end{SCfigure}

\subsection{Superposition and convolution approximations}

\todo{Finish this section}
In the Kirkwood superposition approximation \cite{KirkwoodJCP1935} many-body correlations are expressed as pairwise products of the two-body correlation function, i.e.
\begin{equation}
  g^{(n)}(\vec{r}^n) =
  \prod_{i < j} g^{(2)}(\vec{r}_i, \vec{r}_j),
\end{equation}
which correctly satisfies the hard-core condition, but violates the sum rule
\begin{equation}
  \begin{aligned}
    \rho^{(n)}(\vec{r}^n) &=
    \frac{1}{\Xi} \sum_{N=n}^\infty \frac{z^N}{(N-n)!} \int e^{-\beta U_N} \, d\vec{r}^{(N-n)} \\
    &=
    \int d\vec{r}_n \left(
    \frac{1}{\Xi} \sum_{N=n}^\infty \frac{z^N}{(N+1 - (n+1))!} \int e^{-\beta U_N} \, d\vec{r}^{(N-(n+1))}
    \right) \\
    &=
    \int d\vec{r}_n \left(
    \frac{1}{\Xi} \sum_{N=n}^\infty \frac{z^N}{(N - (n+1))!} \int e^{-\beta U_N} \, d\vec{r}^{(N-(n+1))}
    \right) \\
    &=
    \frac{1}{N-n}
    \int \rho^{(n+1)}(\{\vec{r}^n, \vec{r}_{n+1}\}) d\vec{r}_{n+1},
  \end{aligned}
\end{equation}\todo{This is wrong.}
and the related convolution approximation \cite{JacksonRMP1962,IchimaruPRA1970,BarratMP1988}%
\todo{Check this expression is correct - it almost certainly is not.}
\begin{equation}
  S^{(n)}(\vec{k}^n) =
  (1 + \tilde{c}^{(n)}(\vec{k}^n))
  \prod_{i < j} S^{(2)}(\vec{k}_i, \vec{k}_j)
\end{equation}
satisfies the sum rule but fails to satisfy the hard-core condition.

%% In equilibrium
%% \begin{equation}
%%   c^{(n)}(\vec{r}^n) =
%%   \left.
%%   \frac{\delta^n \beta F_{ex}}{\delta \rho(\vec{r}_1)\delta \rho(\vec{r}_2) \cdots \delta \rho(\vec{r}_n)}
%%   \right|_{\rho(\vec{r})=\rho}
%% \end{equation}

\subsection{Variational principle}

\todo{Finish this section}

Hitherto we have defined all of the functionals for their equilibrium.
We can imagine a generalisation to non-equilibrium density profiles.
\begin{align*}
  \Omega &\to \Omega[\rho]
  \\
  \mathcal{F}^\mathrm{id} &\to \mathcal{F}^\mathrm{id}[\rho]
  \\
  \mathcal{F}^\mathrm{ex} &\to \mathcal{F}^\mathrm{ex}[\rho]
\end{align*}
This generalised functional is not strictly the same as the thermodynamic grand potential, which concerns equilibrium properties, but the two potentials share an important correspondence due to the following two properties:
\begin{enumerate}
  \item It is bounded from below by the grand potential
    \begin{equation}
      \Omega[\rho] \ge \Omega[\rho^{(1)}]
    \end{equation}
  \item with equality only in the case of the equilibrium density profile, i.e.\
    \begin{equation}
      \Omega[\rho^{(1)}] = \Omega
    \end{equation}
\end{enumerate}
These two properties can be elegantly summarised by the following \emph{variational principle}:
\begin{equation}\label{eq:dft-equilibrium}
  \left.
  \frac{
    \delta \Omega[\rho(\vec{r})]
  }{
    \delta \rho
  }
  \right|_{\rho(\vec{r})=\rho^{(1)}(\vec{r})}
  =
  0
\end{equation}
This variational principle provides a route to numerical applications of DFT: minimising the grand potential provides an equilibrium density profile and free energy.

Which gives the equilibrium density as
\begin{equation}
  \rho^{(1)}(\vec{r})
  =
  \frac{
    \exp{\left(\beta\psi(\vec{r}) + c^{(1)}(\vec{r})\right)}
  }{ \Lambda^d }
\end{equation}
