\section{Statistical physics of fluids}

%% \subsection{Notes}

%% Here we talk in general terms about descriptions of the liquid state.
%% Broadly speaking, in its historical development approaches can be placed inside one of two categories.
%% Namely, theories involving
%% \begin{enumerate}
%%   \item Local geometric approximations capturing the short range interactions (free volume theory/cell theory, scaled particle theory), and
%%   \item Integral equations (Ornstein-Zernike closures, density functional theory) which properly treat the long range correlations.
%% \end{enumerate}
%% These two approaches are not mutually exclusive, and hybrid theories can improve on.
%% For instance, fundamental measure theory (FMT) involves the synthesis of integral geometry with the formalism of density functional theory which involves minimising a functional (i.e.\ an integral equation).

%% Classical theory of phase transitions (Landau).
%% Van der waals theory.
%% How does the transition occur?
%% Metastability leads into kinetics.

%% Kinetics vs thermodynamics.
%% Thermodynamic driving force vs activation barrier.

%% Relaxation behaviour controlled by activation barrier.
%% A thermal fluctuation which takes the system over the barrier%
%% \marginfootnote{These fluctuations are conventionally called \emph{instantons} as they spontaneously appear and vanish just like virtual particles in fundamental physics.
%%   The name for this relatively straightforward phenomenon is thus a reference to a much more counterintuitive and bizarre phenomenon, because physicists are good at making helpful analogies.}
%% occurs with rate $\exp{-\beta \Delta U}$ \cite{Langer}.

%% Liquids:
%% Free volume theory.
%% Early curvature corrections.
%% Free volume theory depends on the free volume (duh).
%% This is an example of an integral geometric theory.
%% Morphological

\subsection{Statistical mechanics}
\label{sec:stat-mech}

In this section we \emph{briefly} introduce the statistical ensembles used throughout the rest of the thesis.
These emerge by considering typical fluctuations of thermodynamic quantities for a subsystem within a macroscopic system called the \emph{ensemble}; the properties of this larger system define average quanties of the subsystem \cite{Landau2008}.
Alternatively, the same formalism can be interpretted from a Bayesian perspective to emerge from maximisation of the entropy%
\marginfootnote{The entropy represents a thermodynamic quantity in the former picture, whereas it represents our own \emph{uncertainty} about the system in the latter.}
subject to the constraint of average energy and (optionally) the average particle number \cite{JaynesPR1957,JaynesPR1957a}.

A $d$-dimensional system of $N$ particles consists of $\vec{r}^N = \{\vec{r}_1, \cdots, \vec{r}_N\} \in \mathbb{R}^{dN}$ coordinates and $\vec{p}^N = \{\vec{p}_1, \cdots, \vec{p}_N\} \in \mathbb{R}^{dN}$ momenta.
The classical Hamiltonian can be decomposed into kinetic and potential terms as in
\begin{equation}
  \mathcal{H}_N(\vec{r}^N, \vec{p}^N)
  =
  K_N(\vec{p}^N) + U_N(\vec{r}^N)
\end{equation}
in the absence of an external field.
Further, we constrain the coordinates inside the volume $V$.
The \emph{canonical} ensemble describes an equilibrium system at constant temperature $T$ with probability measure%
\marginfootnote{As a reminder for the reader, in the previous chapter we introduced $\beta = (k_B T)^{-1}$, with Boltzmann constant $k_B$ and temperature $T$.}[2cm]
\begin{equation}
  f^{(N)}(\vec{r}^N, \vec{p}^N) \propto e^{-\beta \mathcal{H}_N}.
\end{equation}
The proportionality constant ensures the probability distribution is properly normalised, leading to the canonical partition function
\begin{equation}
  Q_N
  =
  \int_{\mathbb{R}^{dN}} \int_{V^N}
  e^{-\beta\mathcal{H}_N}
  d\vec{r}^N d\vec{p}^N.
\end{equation}
Classically, the kinetic energy is simply
\begin{equation*}
  K_N(\vec{p}^N) = \sum_{i=1}^N \frac{|\vec{p}_i|^2}{2m_i}
\end{equation*}
which can be integrated leaving
\begin{equation}
  Q_N = \frac{Z_N}{\Lambda^{dN} N!}
\end{equation}
where $\Lambda$ is the thermal de Broglie wavelength, and the configurational integral is given by
\begin{equation}\label{eq:canonical-partition}
  Z_N
  =
  \int_{V^N}
  e^{-\beta U_N}
  d\vec{r}^N.
\end{equation}
Averaged quantities with $N$ fixed are obtained through
\begin{equation*}\label{eq:canonical-average}
  \left< \cdots \right>_N
  =
  \frac{1}{Z_N}
  \int_{V^N} \left(\cdots\right) e^{-\beta U_N} d\vec{r}^N,
\end{equation*}
and the Helmholtz free energy is given by
\begin{equation*}
  \beta F = -\ln{Z_N}.
\end{equation*}

We will work almost exclusively in the \emph{grand canonical ensemble}, where particle number varies according to a chemical potential $\mu$, which is convenient for liquid state descriptions%
\marginfootnote{Notably the free energy is extensive without invoking Stirling's approximation for $N!$, making the thermodynamics properly self-consistent even with small system sizes.}.
The corresponding partition function features summation over $N$, as in
\begin{equation}\label{eq:grand-canonical-partition}
  \Xi
  =
  \sum_{N=0}^\infty \frac{z^N}{N!} Z_N
  =
  \sum_{N=0}^\infty \frac{z^N}{N!}
  \int_{V^N} e^{-\beta U_N} d\vec{r}^N,
\end{equation}
where the activity is $z = \exp{(\beta\mu)} / \Lambda^d$.
Accordingly, average quantities are found via
\begin{equation}\label{eq:grand-canonical-average}
  \left< \cdots \right>
  =
  \frac{1}{\Xi} \sum_{N=0}^\infty \frac{z^N}{N!}
  \int_{V^N} \left(\cdots\right) e^{-\beta U_N} d\vec{r}^N,
\end{equation}
and the corresponding free energy (or \emph{grand potential}) is obtained via
\begin{equation*}
  \beta \Omega = -\ln{\Xi}.
\end{equation*}
For a homogeneous system this reduces to the standard result
\begin{equation}\label{eq:homogeneous-grand-potential}
  \Omega_\mathrm{hom} = - p V.
\end{equation}
Thermodynamic quantities are easily calculated for the ideal gas, e.g.\
\begin{equation*}
  \beta\Omega = - \frac{e^{\beta\mu^\mathrm{id}}}{\Lambda^d} V.
\end{equation*}
Comparing the homogeneous result \eqref{eq:homogeneous-grand-potential} with the ideal gas law $\beta p = \rho$ gives the chemical potential of an ideal gas as
\begin{equation}\label{eq:ideal-chemical-potential}
  \beta \mu^\mathrm{id} = \ln{(\Lambda^d \rho)}.
\end{equation}
From the Legendre transform of the grand potential
\begin{equation}\label{eq:grand-potential-legendre-transform}
  \Omega = F - \mu N
\end{equation}
we obtain the free energy density of an ideal gas as
\begin{equation}\label{eq:ideal-free-energy-density}
  \frac{\beta F^\mathrm{id}}{V} = \rho (\ln{(\Lambda^d \rho)} - 1).
\end{equation}
Finally, for interacting systems the chemical potential and free energy are typically separated into \emph{ideal} and \emph{excess} parts, as in
\begin{align*}
  \beta \mu &= \beta \mu^\mathrm{id} + \beta \mu^\mathrm{ex},
  \\
  \beta F &= \beta F^\mathrm{id} + \beta F^\mathrm{ex},
\end{align*}
with the ideal contributions as expressed above.

\subsection{Liquid structure}
\label{sec:liquid-structure}

Interparticle interactions induce spatial structure in the liquid which are characterised by several (equivalent) hierarchies of correlation functions.
The most natural description of structure starts from the \emph{$n$-particle density}
\begin{equation}\label{eq:n-particle-density-pdf}
  \mathrm{Prob}\left[ \textit{any } n \textrm{ particles in volume } d\vec{r}^n \right]
  :=
  \rho^{(n)}(\vec{r}^n) \, d\vec{r}^n,
\end{equation}
where $\vec{r}^n := \{\vec{r}_1, \cdots, \vec{r}_n\}$ are the particle positions.
This is formally obtained by integrating the full (configurational) probability distribution over the remaining degrees of freedom.
For the single-component system this yields~\cite{Hansen2013}
\begin{equation}\label{eq:n-particle-density}
  \rho^{(n)}(\vec{r}^n)
  =
  \frac{1}{\Xi}
  \sum_{N=n}^\infty \frac{z^N}{(N-n)!}
  \int_{V^N} e^{-\beta U_N} \, d\vec{r}^{(N-n)}.
\end{equation}
The $n$-particle density is an intuitive descriptor for liquid structure because it generalises the probability density function for a closed system, i.e.\
\begin{equation*}
  \mathrm{Prob}\left[ N \textrm{ particles in volume } d\vec{r}^n \right]
  :=
  \frac{e^{-\beta U_N}}{Z_N} \, d\vec{r}^N,
\end{equation*}
to a subset of particles within an open system.
$\rho^{(n)}$ thus provides the correct procedure for coarse-graining onto selected degrees of freedom within a bulk system.
The analogy with canonical ensemble fails in that $\rho^{(n)}$ is unnormalised so it is not strictly a probability density function; integrating \eqref{eq:n-particle-density} over the remaining degrees of freedom yields%
\marginfootnote{In keeping with the analogy to canonical ensemble we treat this integral as a partition function, and so account for indistinguishability of the $n$ particles by dividing through by $n!$.}
\begin{equation*}\label{eq:n-particle-density-normalisation}
  \frac{1}{n!}
  \int_{V^n} \rho^{(n)}(\vec{r}^n) \, d\vec{r}^n
  =
  \left\langle \frac{N!}{n! (N-n)!} \right\rangle
\end{equation*}
i.e.\ the average binomial coefficient.
The $n$-particle density scales proportionally to $\rho^n$ so it is usual to remove this by defining the \emph{$n$-particle distribution function} as
\begin{equation}\label{eq:n-particle-distribution}
  g^{(n)}(\vec{r}^n)
  :=
  \frac{\rho^{(n)}(\vec{r}^n)}{\prod_{i=1}^n \rho^{(1)}(\vec{r}_i)},
\end{equation}
which provides our first (and primary) hierarchy of correlation functions.

Physically, particles become decorrelated when they are separated by macroscopic distances%
\marginfootnote{This limit behaviour is only valid for `normal' liquid behaviour far from the critical point where the correlation length diverges.}.
This property manifests in the distribution functions via a \emph{product property} where \cite{UhlenbeckJMP1963}
\begin{equation*}
  g^{(n)}(\vec{r}^n)
  \simeq
  g^{(s)}(\vec{r}^s) \, g^{(n-s)}(\vec{r}^{n-s})
\end{equation*}
in the limit where the $s$ particles become macroscopically separated from the remaining $(n-s)$ particles.
This property causes the distribution functions to decay to their ideal gas value $g^{(n)}(\vec{r}^n) \to 1$ in the limit of infinite separations between all particles.
Moreover, the product property suggests that there is a great deal of redundancy inside the distribution functions; in certain applications it is convenient to introduce an additional hierarchy of correlation functions which only capture the excess correlations.
If we imagine the normalisation of the distribution functions $g^{(n)}$ as \emph{moments} of an unspecified probability distribution, then we can formally imagine a dual set of correlation functions $h^{(n)}$ which generate the \emph{cumulants}.
Formally, this relationship is expressed \cite{Santos2016}
\begin{equation*}\label{eq:correlation-moment-generating-function}
  1
  + \sum_{n=1}^\infty \frac{\epsilon^n}{n!}
  \int_{V^n} g^{(n)}(\vec{r}^n) \, d\vec{r}^n
  =
  \exp{
    \left(
    \sum_{n=1}^\infty \frac{\epsilon^n}{n!}
    \int_{V^n} h^{(n)}(\vec{r}^n) \, d\vec{r}^n
    \right)
  },
\end{equation*}
with $\epsilon$ as a formal expansion parameter of the moment generating function.
In addition, we require that these new functions share the same symmetries as $g^{(n)}$ e.g.\ permutation invariance in the arguments.
These conditions specify a new hierarchy: the \emph{cluster correlation functions}%
\marginfootnote{These are so-named because they possess a \emph{cluster property} where they decay to zero in the limit where any particles become macroscopically separated \cite{UhlenbeckJMP1963}.
  This feature directly emerges from, and is dual to, the product property for $g^{(n)}$.}
where the first few terms are given by \cite{UhlenbeckJMP1963}
\begin{subequations}\label{eq:cluster-correlation-functions}
  \begin{align}
    h^{(1)}(\vec{r})
    =& \,
    g^{(1)}(\vec{r}),
    \\
    h^{(2)}(\vec{r}_1, \vec{r}_2)
    =& \,
    g^{(2)}(\vec{r}_1, \vec{r}_2)
    - g^{(1)}(\vec{r}_1) g^{(1)}(\vec{r}_2),
    \label{eq:pair-cluster-correlation-function}
    \\
    h^{(3)}(\vec{r}_1, \vec{r}_2, \vec{r}_3)
    =& \,
    g^{(3)}(\vec{r}_1, \vec{r}_2, \vec{r}_3)
    - \{3\} g^{(2)}(\vec{r}_1, \vec{r}_2) g^{(1)}(\vec{r}_3)
    %- g^{(2)}(\vec{r}_2, \vec{r}_3) g^{(1)}(\vec{r}_1)
    \nonumber \\ & \,
    %- g^{(2)}(\vec{r}_3, \vec{r}_1) g^{(1)}(\vec{r}_2)
    + g^{(1)}(\vec{r}_1) g^{(1)}(\vec{r}_2) g^{(1)}(\vec{r}_3),
  \end{align}
\end{subequations}
where $\{\cdot\}$ indicates the number of similar terms which differ only by permutation of indices which we omit for brevity.
The pair cluster correlation function%
\marginfootnote{This is often called simply the \emph{total correlation function}, especially in the context of integral equation theories (cf.\ section \ref{sec:oz-equation}).}
$h^{(2)}(\vec{r}_1, \vec{r}_2) = g^{(2)}(\vec{r}_1, \vec{r}_2) - 1$ is the main function we will use from this hierarchy.

We can define two further hierarchies of correlation functions from the moments and fluctuations in the density.
Writing the instantaneous density as
\begin{equation*}\label{eq:instantaneous-density}
  \hat\rho(\vec{r}) = \sum_{i=1}^N \delta(\vec{r} - \vec{r}_i)
\end{equation*}
where $\delta(\cdot)$ is the Dirac delta function, then the various \emph{density moments} are determined as
%% Similarly, we can define higher-order moments of the instantaneous density in terms of $\rho^{(n)}$ giving e.g.\
\begin{subequations}
  \begin{align}
    \langle \hat\rho(\vec{r}) \rangle
    =& \,
    \rho^{(1)}(\vec{r}),
    \label{eq:single-particle-density}
    \\
    \big\langle \hat\rho(\vec{r}_1) \hat\rho(\vec{r}_2) \big\rangle
    =& \,
    \rho^{(2)}(\vec{r}_1, \vec{r}_2) +
    \rho^{(1)}(\vec{r}_1) \delta(\vec{r}_1 - \vec{r}_2),
    \\
    \big\langle \hat\rho(\vec{r}_1) \hat\rho(\vec{r}_2) \hat\rho(\vec{r}_3) \big\rangle
    =& \,
    \rho^{(3)}(\vec{r}_1, \vec{r}_2, \vec{r}_3) +
    \{3\} \rho^{(2)}(\vec{r}_1, \vec{r}_2) \delta(\vec{r}_1 - \vec{r}_3)
    \nonumber \\ & \,
    + \rho^{(1)}(\vec{r}_1) \delta(\vec{r}_1 - \vec{r}_2) \delta(\vec{r}_1 - \vec{r}_3).
  \end{align}
\end{subequations}
Importantly, \eqref{eq:single-particle-density} shows that the single-particle density is simply the equilibrium density profile.
The normalisation of these functions gives the moments of particle number $N$, i.e.\
\begin{equation}
  \int_{V^n}
  \left\langle
  \prod_{i=1}^n \hat\rho(\vec{r}_i)
  \right\rangle
  \, d\vec{r}^n
  =
  \left\langle N^n \right\rangle.
\end{equation}
We can define a dual hierarchy of \emph{density-density correlation functions} $H^{(n)}$ by the same procedure used to generate $h^{(n)}$ from $g^{(n)}$, i.e.\ through a cumulant generating function.
The first few functions in this hierarchy are
\begin{subequations}
  \begin{align}
    H^{(1)}(\vec{r})
    =& \,
    %% \big\langle \hat\rho(\vec{r}) \big\rangle
    %% =
    \rho^{(1)}(\vec{r}),
    \\
    H^{(2)}(\vec{r}_1, \vec{r}_2)
    =& \,
    \big\langle \hat\rho(\vec{r}_1) \hat\rho(\vec{r}_2) \big\rangle
    - \rho^{(1)}(\vec{r}_1) \rho^{(1)}(\vec{r}_2),
    \label{eq:pair-density-density-correlation}
    \\
    H^{(3)}(\vec{r}_1, \vec{r}_2, \vec{r}_3)
    =& \,
    \big\langle \hat\rho(\vec{r}_1) \hat\rho(\vec{r}_2) \hat\rho(\vec{r}_3) \big\rangle
    - \{3\} \big\langle \hat\rho(\vec{r}_1) \hat\rho(\vec{r}_2) \big\rangle \rho^{(1)}(\vec{r}_3)
    %- \big\langle \hat\rho(\vec{r}_2) \hat\rho(\vec{r}_3) \big\rangle \rho^{(1)}(\vec{r}_1)
    \nonumber \\ & \,
    %- \big\langle \hat\rho(\vec{r}_3) \hat\rho(\vec{r}_1) \big\rangle \rho^{(1)}(\vec{r}_2)
    + \rho^{(1)}(\vec{r}_1) \rho^{(1)}(\vec{r}_2) \rho^{(1)}(\vec{r}_3),
  \end{align}
\end{subequations}
or more generally \cite{Hansen2013}
\begin{equation}\label{eq:density-density-correlations}
  H^{(n)}(\vec{r}^n)
  =
  \left\langle
  \prod_{i=1}^n
  \Big[ \rho(\vec{r}_i) - \rho^{(1)}(\vec{r}_i) \Big]
  \right\rangle
  \qquad \forall \; n \ge 2.
\end{equation}
The normalisations of $H^{(n)}$ give the cumulants in $N$ i.e.\
\begin{equation*}
  \int_{V^n} H^{(n)}(\vec{r}^n) \, d\vec{r}^n
  =
  \frac{d^n}{d\epsilon^n}
  \left[
  \log{\left(
      1 + \sum_{m=1}^\infty
      \frac{\epsilon^m}{m!} \left\langle N^m \right\rangle
      \right)}
  \right]_{\epsilon = 0}
\end{equation*}
or explicitly for the first few functions
\begin{subequations}
  \begin{align}
    \int_V H^{(1)}(\vec{r}) \, d\vec{r}
    &=
    \langle N \rangle,
    \\
    \int_{V^2} H^{(2)}(\vec{r}_1, \vec{r}_2) \, d\vec{r}_1 d\vec{r}_2
    &=
    \langle N^2 \rangle - \langle N \rangle^2,
    \label{eq:pair-density-density-norm}
    \\
    \int_{V^3} H^{(3)}(\vec{r}_1, \vec{r}_2, \vec{r}_3) \, d\vec{r}_1 d\vec{r}_2 d\vec{r}_3
    &=
    \langle N^3 \rangle
    - 3 \langle N^2 \rangle \langle N \rangle
    + 2 \langle N \rangle^3.
  \end{align}
\end{subequations}
This class of correlation functions thus describes the fluctuations in density, which can play an important thermodynamic role; we will give a specific example of how these functions connect to thermodynamic response functions below.

An important response function for liquid structure is the isothermal compressibility
\begin{equation*}\label{eq:isothermal-compressibility}
  \kappa_T
  :=
  %% - \frac{1}{V}
  %% \left( \frac{\partial V}{\partial p} \right)_{N,T}.
  \frac{1}{\rho}
  \left( \frac{\partial \rho}{\partial p} \right)_{V,T}.
\end{equation*}
Using standard thermodynamic manipulations we can obtain the equivalent expression
\begin{equation*}
  \kappa_T
  =
  \frac{1}{\rho^2}
  \left( \frac{\partial \rho}{\partial \mu} \right)_{V,T}
\end{equation*}
or defining the dimensionless \emph{isothermal susceptibility} as \begin{equation*}\label{eq:isothermal-susceptibility}
  \chi_T
  :=
  \rho k_B T \kappa_T
  =
  \frac{1}{\rho}
  \left( \frac{\partial \rho}{\partial (\beta \mu)} \right)_{V,T}.
\end{equation*}
It is straightforward to evaluate this through the grand canonical average \eqref{eq:grand-canonical-average} of density $\rho = \langle N \rangle / V$, obtaining
\begin{equation}
  \chi_T
  =
  \frac{ \langle N^2 \rangle - \langle N \rangle^2 }{\langle N \rangle}.
\end{equation}
From the normalisation of $H^{(2)}$ \eqref{eq:pair-density-density-norm} as the second cumulant in $N$, we find
\begin{equation}\label{eq:compressibility-h2}
  \begin{split}
    \chi_T
    &=
    \frac{1}{\langle N \rangle}
    \int_{V^2} H^{(2)}(\vec{r}_1, \vec{r}_2) \, d\vec{r}_1 d\vec{r}_2
    \\ &=
    1
    + \rho \int_V h^{(2)}(\vec{r}) \, d\vec{r}
  \end{split}
\end{equation}
where the latter step is valid for the homogeneous liquid where $g^{(2)}(\vec{r}_1, \vec{r}_2) = g^{(2)}(\vec{r}_2 - \vec{r}_1)$ and we used the pair cluster correlation function \eqref{eq:pair-cluster-correlation-function}.

The various correlation functions introduced are all structural descriptors in real space, but we can imagine equivalent descriptors in Fourier space.
The most important Fourier space correlation are the static structure factors $S^{(n)}$, of which the pair structure factor $S^{(2)}$ is particularly important for scattering experiments.
We define this from the Fourier transform of the pair distribution function in the case of the uniform liquid as
\begin{equation}\label{eq:static-structure-factor}
  \begin{split}
    S^{(2)}(\vec{k})
    :=&
    \frac{
      \big\langle \tilde{\rho}(\vec{k}) \tilde{\rho}(-\vec{k}) \big\rangle
    }{
      \langle N \rangle
    }
    =
    1 + \rho \tilde{g}^{(2)}(\vec{k})
    \\ =&
    1 + \rho \tilde{h}^{(2)}(\vec{k}) + \rho \delta(\vec{k})
  \end{split}
\end{equation}
where the tilde over a function denotes its Fourier transform.
In terms of the structure factor \eqref{eq:compressibility-h2} is written succinctly as%
\marginfootnote{The Dirac delta function at the origin in $S^{(2)}(\vec{k})$ is often omitted to regularise the function, in which case the right-hand side can be written more simply as $S^{(2)}(0)$.}
\begin{equation}
  \chi_T = \lim_{\vec{k} \to 0} S^{(2)}(\vec{k}).
\end{equation}

%% \todo{Kirkwood superposition and convolution approximations}

%% \subsection{?}

%% \todo{Finish this section}

%% \begin{equation}
%%   \chi_T \rho
%%   \left( \frac{\partial \rho^{(n)}}{\partial \rho} \right)_{V,T}
%%   =
%%   (n - \rho V) \rho^{(n)}(\vec{r}^n)
%%   + \int \rho^{(n+1)}(\vec{r}^{n+1}) \, d\vec{r}_{n+1}
%% \end{equation}
%% \begin{equation}
%%   \left( \frac{\partial g^{(n)}(\vec{r}^n)}{\partial \rho} \right)_{V,T}
%%   =
%%   \frac{1}{\rho^n}
%%   \left( \frac{\partial \rho^{(n)}(\vec{r}^n)}{\partial \rho} \right)_{V,T}
%%   - \frac{n}{\rho} g^{(n)}(\vec{r}^n)
%% \end{equation}
%% \begin{equation}
%%   \begin{split}
%%     \frac{\chi_T}{\rho^n}
%%     \left( \frac{\partial \rho^{(n)}}{\partial \rho} \right)_{V,T}
%%     &=
%%     \left(\frac{n}{\rho} - V\right) g^{(n)}(\vec{r}^n)
%%     + \int g^{(n+1)}(\vec{r}^{n+1}) \, d\vec{r}_{n+1}
%%     \\ &=
%%     \chi_T \left( \frac{\partial g^{(n)}}{\partial \rho} \right)_{V,T}
%%     + \chi_T \frac{n}{\rho} g^{(n)}
%%   \end{split}
%% \end{equation}
%% \begin{equation}
%%   \chi_T \left( \frac{\partial g^{(n)}}{\partial \rho} \right)_{V,T}
%%   =
%%   \left(
%%   \frac{n (1 - \chi_T)}{\rho}
%%   - V
%%   \right) g^{(n)}(\vec{r}^n)
%%   + \int g^{(n+1)}(\vec{r}^{n+1}) \, d\vec{r}_{n+1}
%% \end{equation}
%% \begin{equation}
%%   \begin{split}
%%     \chi_T \left( \frac{\partial g^{(2)}}{\partial \rho} \right)_{V,T}
%%     &=
%%     \left(
%%     \frac{2 (1 - \chi_T)}{\rho}
%%     - V
%%     \right) g^{(2)}(\vec{r}^2)
%%     + \int g^{(3)}(\vec{r}^3) \, d\vec{r}_3
%%     \\
%%     \left( \frac{\partial g^{(2)}}{\partial \rho} \right)_{V,T}
%%     &=
%%     \frac{2 (1 - \chi_T)}{\rho \chi_T}
%%     g^{(2)}(\vec{r}^2)
%%     +
%%     \int g^{(3)}(\vec{r}^3) - \rho g^{(2)}(\vec{r}^2) \, d\vec{r}_3
%%   \end{split}
%% \end{equation}

\subsection{Thermodynamic routes to the free energy}
\label{sec:thermodynamic-routes}

Often the main objective of a statistical physicist is to determine the phase diagram of a system, which can be deduced from the free energy if known.
Liquid state theory contains several routes to calculate the free energy, of which we will describe two below.
Ordinarily, the end result of these approaches is an equation of state for the pressure $p = p(\rho)$, giving the free energy implicitly through the thermodynamic relation
\begin{equation}\label{eq:pressure-relation-1}
  p
  =
  - \left( \frac{\partial F}{\partial V} \right)_{N,T},
\end{equation}
although a state equation for any other thermodynamic observable would suffice.

The first option for determining the free energy is through the compressibility, from the thermodynamic relation
\begin{equation}
  \frac{1}{\chi_T}
  %% =
  %% - V \left( \frac{\partial p}{\partial V} \right)_{N,T}
  =
  \left( \frac{\partial \beta p}{\partial \rho} \right)_{V,T}.
  %% =
  %% V \left( \frac{\partial^2 F}{\partial V^2} \right)_{N,T}
  %% =
  %% \frac{\rho^2}{V}
  %% \left( \frac{\partial^2 F}{\partial \rho^2} \right)_{N,T}
\end{equation}
Integrating this relation over the density and making use of the isothermal compressibility identity for a uniform system \eqref{eq:compressibility-h2} gives
\begin{equation}\label{eq:compressibility-route-pressure}
  \beta p
  %% =
  %% \int_0^\rho \frac{1}{\rho' k_B T \kappa_T} d\rho'
  =
  \int_0^\rho \frac{1}{\chi_T} d\rho'
  %% =
  %% \int_0^\rho \frac{1}{1 + \rho \int h^{(2)}(\vec{r}) \, d\vec{r}} d\rho',
  =
  \int_0^\rho \lim_{\vec{k} \to 0} \frac{1}{S^{(2)}(\vec{k})} d\rho',
\end{equation}
i.e.\ the \emph{compressibility route} to the pressure.

Another option evaluates the pressure directly \eqref{eq:pressure-relation-1} from the partition function.
In terms of the canonical partition function this is
\begin{equation}\label{eq:pressure-relation-2}
  \beta p
  =
  \left( \frac{\partial (\ln{Z_N})}{\partial V} \right)_{N,T}.
\end{equation}
We consider what happens during a volume change $V \to \alpha^d V$ emerging from the affine rescaling $\vec{r} \to \alpha \vec{r}$, so that the configurational integral \eqref{eq:canonical-partition} becomes
\begin{equation}\label{eq:inflated-canonical-partition}
  Z_N(\alpha^d V)
  =
  \int_{\alpha V^N} e^{-\beta U_N(\vec{r}^N)} d\vec{r}^N
  =
  \alpha^{dN}
  \int_{V^N} e^{-\beta U_N(\alpha \vec{r}^N)} d\vec{r}^N
\end{equation}
Using the identity
\begin{equation*}
  \frac{\partial f(xy)}{\partial y}
  =
  \frac{x}{y} \frac{\partial f(xy)}{\partial x},
\end{equation*}
we can write
\begin{equation}
  \frac{\partial (\ln{Z_N(\alpha^d V)})}{\partial V}
  =
  \frac{\alpha}{d V}
  \frac{\partial (\ln{Z_N(\alpha^d V)})}{\partial \alpha}.
\end{equation}
This trick allows the pressure relation \eqref{eq:pressure-relation-2} to be re-expressed as
\begin{equation*}
  \frac{\beta p}{\rho}
  =
  \frac{1}{d N}
  \left.
  \frac{\partial (\ln{Z_N(\alpha^d V)})}{\partial \alpha}
  \right|_{\alpha = 1}.
\end{equation*}
The derivative of \eqref{eq:inflated-canonical-partition} with respect to $\alpha$ can be calculated explicitly as
\begin{equation*}
  \begin{split}
    \frac{\partial Z_N(\alpha^d V)}{\partial \alpha}
    &=
    %% \frac{\partial}{\partial \alpha}
    %% \left(
    %% \int_{V^N} e^{-\beta U_N(\alpha^d \vec{r}^N)} d\vec{r}^N
    %% \right)
    %% \\ &=
    \frac{dN}{\alpha} Z_N
    +
    \alpha^{dN}
    \int_{V^N}
    \frac{\partial}{\partial \alpha}
    \left( e^{-\beta U_N(\alpha \vec{r}^N)} \right)
    d\vec{r}^N
    \\ &=
    \frac{dN}{\alpha} Z_N
    -
    \alpha^{dN}
    %\sum_{i,j}
    \int_{V^N}
    \frac{\partial \beta U_N(\alpha \vec{r}^N)}{\partial \alpha}
    e^{-\beta U_N}
    d\vec{r}^N,
  \end{split}
\end{equation*}
giving the final result
\begin{equation}\label{eq:virial-route-pressure}
  \begin{split}
    \frac{\beta p}{\rho}
    &=
    1
    -
    \frac{1}{\rho d Z_N}
    \int_{V^N}
    \left.
    \frac{\partial \beta U_N(\alpha \vec{r}^N)}{\partial \alpha}
    \right|_{\alpha = 1}
    e^{-\beta U_N}
    d\vec{r}^N
    \\ &=
    1
    -
    \frac{1}{\rho d}
    \left\langle
    \left.
    \frac{\partial \beta U_N(\alpha \vec{r}^N)}{\partial \alpha}
    \right|_{\alpha = 1}
    \right\rangle,
  \end{split}
\end{equation}
which is known as the \emph{virial route}%
\marginfootnote{This is so-named because historically it was derived through the virial theorem.
Despite the similar name, this approach has no relation to the virial series which will be introduced in section \ref{sec:virial-series}.}
to the pressure.
In the latter step we replaced the canonical average with the grand-canonical average \eqref{eq:grand-canonical-average} from ensemble equivalence in the thermodynamic limit.

There are other routes involving different observables (e.g.\ through the potential energy or the chemical potential \cite{Santos2016}) to obtain the equation of state from the correlation functions; however, we will not discuss them as we will only use the virial route in the results chapters.
The degree of self-consistency between different routes can act as a proxy for the accuracy of an approximate theory.

\vspace{0.5em}
\begin{tcolorbox}[title=Contact theorem for hard spheres]
  For a single-component system interacting through a spherically symmetric pair potential $u(r)$, the virial route \eqref{eq:virial-route-pressure} yields
  \begin{equation}\label{eq:virial-route-pressure-uniform}
    \frac{\beta p}{\rho}
    =
    1
    -
    \frac{\rho}{2 d}
    \int_V
    r g^{(2)}(r) \frac{d \beta u}{d r} \, d\vec{r},
  \end{equation}
  using the definition of the 2-particle distribution function \eqref{eq:n-particle-distribution} as the average over the remaining degrees of freedom.
  In the case of hard spheres $u'(r)$ is not well-defined because the pair potential \eqref{eq:hs-interaction} is singular, however the cavity function
  \begin{equation*}\label{eq:cavity-function}
    y^{(2)}(r) = g^{(2)}(r) e^{\beta u(r)}
  \end{equation*}
  is continuous (see e.g.\ Refs.\ \cite{Hansen2013,Santos2016}) even in cases where the pair potential is not.
  In terms of the cavity function, the virial route \eqref{eq:virial-route-pressure-uniform} becomes
  \begin{equation*}\label{eq:virial-route-pressure-cavity}
    \frac{\beta p}{\rho}
    =
    1
    +
    \frac{\rho}{2 d}
    \int_V
    r y^{(2)}(r) \frac{d}{dr} \left( e^{-\beta u(r)} \right)
    d\vec{r},
  \end{equation*}
  which for $d$-dimensional hard spheres of diameter $\sigma$ yields the \emph{contact theorem}:
  \begin{equation}\label{eq:contact-theorem}
    \frac{\beta p}{\rho}
    =
    1
    +
    \frac{\eta (2\sigma)^d}{2}
    y^{(2)}(\sigma).
    %% \\ &=
    %% 1
    %% +
    %% \frac{\rho \omega_d \sigma^d}{2}
    %% y^{(2)}(\sigma)
  \end{equation}
  The pair distribution function $g^{(2)}$ appeared in the virial route because the specified system interacts via a pair potential; we could reasonably expect the generalisation to an $n$-body interaction potential to give the equation of state in terms of the $n$-body distribution function $g^{(n)}$.
\end{tcolorbox}

\subsection{Virial series}
\label{sec:virial-series}

The virial series provides the only properly rigorous approach to evaluating the partition function, and thus the free energy, from first principles.
We introduce it here as it will be used in chapter \ref{chapter:resummation} to place the fundamental approximation, the morphometric approach, underlying chapters \ref{chapter:morphometric-framework} and \ref{chapter:morphometric-applications} on firmer ground.
This approach can be used to derive free energy functionals for application to (classical) density functional theory (section \ref{sec:dft}): cf.\ Refs.\ \cite{LeithallPRE2011,KordenPRE2012,MarechalPRE2014}.
The series derived below is only valid for systems interacting via a pair potential $u(\vec{r})$.

The partition function $\Xi$, defined in \eqref{eq:grand-canonical-partition}, is an expansion in \emph{fugacity} featuring intractable integrals; the trick to make calculations more tractable is to transform $\Xi$ into a \emph{density} expansion.
The final series involves an infinite number of individually more tractable integrals.
Traditionally, the virial series for the equation of the state is written
\begin{equation}\label{eq:virial-series-pressure}
  \frac{\beta p}{\rho}
  =
  1 + \sum_{n=2}^\infty B_n \rho^{n-1}
\end{equation}
where $\{B_n\}$ are the \emph{virial coefficients} to be determined.
As a self-consistency check, observe that the ideal gas law is recovered in the low density limit $\rho \to 0$.
Alternatively, the virial series can be expressed for the (excess) free energy density, defined through
\begin{equation}\label{eq:free-energy-density}
  \beta f^\mathrm{ex}
  :=
  \frac{\beta F^{ex}}{V}
  =
  \rho \int_0^\rho \left( \frac{\beta p}{\rho'} - 1 \right)
  \frac{d\rho'}{\rho'}.
\end{equation}
Inserting the virial expression \eqref{eq:virial-series-pressure} gives
\begin{equation}\label{eq:virial-series-excess-free-energy}
  \beta f^\mathrm{ex}
  =
  \sum_{n=2}^\infty
  \frac{1}{n-1}
  B_n
  \rho^n
\end{equation}
which is more useful for connecting with density functional theory approaches (section \ref{sec:dft}).

To determine the coefficients in the virial series, we start by writing the Boltzmann factor for a pairwise interacting system as the product
\begin{equation}
  e^{-\beta U_N(\vec{r}^N)}
  =
  \prod_{1 \le i < j \le N} (1 + f_{ij})
\end{equation}
where we introduced the \emph{Mayer function}
\begin{equation}
  f_{ij} := e^{-\beta u(\vec{r}_i, \vec{r}_j)} - 1.
\end{equation}
Expanding out terms in the $n$-particle configurational integral leads to expressions like
\begin{equation*}
  \begin{split}
    Z_3
    =&
    \frac{z^3}{3!}
    \int (1 + f_{12}) (1 + f_{23}) (1 + f_{31})
    \, d\vec{r}_1 d\vec{r}_2 d\vec{r}_3
    \\ =&
    \frac{z^3}{3!}
    \int_{V^3} (1 + \{3\} f_{12} + \{3\} f_{12} f_{23} + f_{12} f_{23} f_{31} )
    \, d\vec{r}_1 d\vec{r}_2 d\vec{r}_3
  \end{split}
\end{equation*}
which is the term for $n=3$.
In the above expression we used the $\{\cdot\}$ notation which we introduced to indicate different permutations in the various standard correlation functions%
\marginfootnote{The notational similarity is not merely superficial: the integrand, the Boltzmann weight, is really another correlation function.}
e.g.\ \eqref{eq:cluster-correlation-functions}.
Expressions involving Mayer functions can become unwieldly so it is usual practice to express them as diagrams: graphs with $n$ vertices connected by edges representing each $f_{ij}$.
For example, the integrand in the above expression would be written
\begin{align}
  %\begin{split}
  &\quad\, 1 &&+ \{3\} \;\;\; f_{12} &&+ \{3\} \; f_{12} f_{23} &&+ f_{12} f_{23} f_{31}
  \\ =&
  \mayerdiagram[...][ooo]{3}
  &&+ \{3\} \mayerdiagram[|..][ooo]{3}
  &&+ \{3\} \mayerdiagram[.||][ooo]{3}
  &&+ \mayerdiagram[|||][ooo]{3}
  .
  %\end{split}
\end{align}
Integrations over the positions of each particle are represented by blackening the integrating vertices, so that the previous integral becomes
\begin{align*}
  Z_3
  =&
  \int_{V^3} (1 + \{3\} f_{12} + \{3\} f_{12} f_{23} + f_{12} f_{23} f_{31} )
  \, d\vec{r}_1 d\vec{r}_2 d\vec{r}_3
  \\ =&
  \mayerdiagram[...]{3}
  + \{3\} \mayerdiagram[|..]{3}
  + \{3\} \mayerdiagram[.||]{3}
  + \mayerdiagram[|||]{3}.
\end{align*}
To make calculations more tractable we have to reduce the total number of diagrams.

Firstly, we will use the same trick as we used to construct dual correlation functions (cf.\ discussion around \eqref{eq:cluster-correlation-functions}): we treat the grand canonical partition function as a moment generating function, with fugacity as the control parameter, and consider its the dual cumulant generating function $\ln{\Xi} = -\beta\Omega$.
It follows that
\begin{equation*}
  1 + \sum_{n=1} \frac{z^n}{n!} Z_n
  =
  \exp{
    \left(
    \sum_{n=1}^\infty \frac{z^n}{n!}
    \int_{V^n} W^{(n)}(\vec{r}^n) \, d\vec{r}^n
    \right)
  },
\end{equation*}
which defines a new hierarchy of \emph{cluster functions}%
\marginfootnote{These are sometimes called \emph{Ursell functions}.}
$W^{(n)}$.
The transformation to cluster functions eliminates all disconnected diagrams, e.g.\ the first few are defined as \cite{Santos2016}
\begin{subequations}
  \begin{align}
    W^{(1)}(\vec{r})
    &=
    1,
    \\
    W^{(2)}(\vec{r}_1, \vec{r}_2)
    &=
    \mayerdiagram[|][oo]{2},
    \\
    W^{(3)}(\vec{r}_1, \vec{r}_2, \vec{r}_3)
    &=
    \{3\} \mayerdiagram[.||][ooo]{3}
    +  \mayerdiagram[|||][ooo]{3}.
  \end{align}
\end{subequations}
The normalisations of these new functions are the so-called \emph{cluster integrals} defined as
\begin{equation}\label{eq:cluster-integral}
  b_n :=
  \frac{1}{n! V}
  \int_{V^n} W^{(n)}(\vec{r}^n)
  \, d\vec{r}^n,
\end{equation}
so that
\begin{equation*}
  \ln{\Xi} = V \sum_{n=1}^\infty b_n z^n.
\end{equation*}
We pulled out a volume factor in front of the definition of $b_n$ so that the cluster integral is an intensive quantity; translation invariance in a homogeneous liquid means that only the relative distances matter in $W^{(n)}$, so we obtain a volume term from integration of the first particle.

Secondly, we transform from an expansion in fugacity to one in density, obtaining the virial coefficients $B_n$ as seen in the pressure \eqref{eq:virial-series-pressure} and free energy \eqref{eq:virial-series-excess-free-energy} expansions.
From the explicit form of the partition function \eqref{eq:grand-canonical-partition} we can write the density as
\begin{equation*}
  \rho
  =
  \frac{z}{V} \frac{\partial (\ln \Xi)}{\partial z},
\end{equation*}
or using the cluster expansion for $\ln{\Xi}$ stated above we obtain
\begin{equation*}
  \rho
  =
  \sum_{n=1}^\infty n b_n z^n.
\end{equation*}
This expression, connecting density and fugacity, can be used to transform the expansion in fugacity to one in density, giving the first few virial coefficients
\begin{subequations}
  \begin{align*}
    B_2 &= -b_2,
    \\
    B_3
    &=
    4 b_2^2 - 2 b_3,
    \\
    B_4
    &=
    -20 b_2^3 + 18 b_2 b_3 - 3 b_4.
  \end{align*}
\end{subequations}

\vspace{0.5em}
\begin{tcolorbox}[title=The virial coefficients]
  Further cancellations occur after inserting the explicit expressions for the cluster integrals \eqref{eq:cluster-integral} into the previous coefficients.
  This remaining terms consist only of the \emph{stars}%
  \marginfootnote{These are also called the \emph{irreducible diagrams} because they cannot be expressed as products of other diagrams.
  In graph theoretic terms, these diagrams would be described as \emph{2-vertex connected}.}:
  those diagrams which cannot be disconnected by deleting a single vertex.
  We obtain the first few virial coefficients as
  \begin{subequations}
    \begin{align}
      \label{eq:virial-B2}
      B_2
      &=
      - \frac{1}{2} \mayerdiagram[|][o.]{2},
      \\
      B_3
      &=
      - \frac{2}{3!} \mayerdiagram[|||][o..]{3},
      \\
      B_4
      &=
      - \frac{2}{3!}
      \left(
      3 \mayerdiagram[|.||.|][o...]{4}
      + 6 \mayerdiagram[|.||||][o...]{4}
      + \mayerdiagram[||||||][o...]{4}
      \right).
    \end{align}
  \end{subequations}
  and more generally \cite{Santos2016, Hansen2013}
  \begin{equation}\label{eq:virial-coefficients}
    B_n = - \frac{n - 1}{n! V}
    \int_{V^n}
    \sum \bigg( \textrm{all \emph{stars} with $n$ vertices} \bigg)
    \, d\vec{r}^n
  \end{equation}
\end{tcolorbox}

In the above derivation we only considered a single-component system, however the generalisation to mixtures is straightforward.
Considering an $m$-component mixture we label each species with index $s \in \{1, \cdots, m\}$.
The virial coefficients generalise to \cite{Santos2016}
\begin{equation}\label{eq:virial-coefficients-mixtures}
  B_n =
  \sum_{s_1=1}^m \cdots \sum_{s_n=1}^m
  B_{s_1, \cdots, s_n} \prod_{i=1}^n x_{s_i}
\end{equation}
where $x_i$ is the mole fraction of species $i$ such that $x_i > 0$ and $\sum_{i=1}^m x_i = 1$.
$B_{s_1, \cdots, s_n}$ are the composition independent virial coefficients describing the contribution from interactions between $n$ particles of species $\{s_1, \cdots, s_n\}$.
In the next section we will discuss important restrictions obtained by requiring self-consistency in the limit of continuous mixtures $m \to \infty$.

\subsection{Truncatability of the free energy: a requirement for self-consistency}
\label{sec:truncatable-free-energy}

Thermodynamic consistency of the (osmotic) pressure requires
\begin{subequations}
  \begin{align}
    \label{eq:consistent-osmotic-pressure}
    \beta p
    &=
    \rho - \beta f^\mathrm{ex}
    + \rho \left( \frac{\partial \beta f^\mathrm{ex}}{\partial \rho} \right)_{V,T},
    \\
    \label{eq:consistent-osmotic-pressure-mixtures}
    &=
    \rho - \beta f^\mathrm{ex}
    + \rho \sum_{i=1}^m
    x_i \left( \frac{\partial \beta f^\mathrm{ex}}{\partial x_i} \right)_{V,T}.
  \end{align}
\end{subequations}
The latter line, valid in the case of discrete mixtures, becomes poorly defined in the \emph{polydisperse} limit $m \to \infty$ with $x_i \to 0$.
A general requirement to remain well-defined in this limit is thus that composition dependence should enter only through a (finite) set of \emph{weighted densities} \cite{GualtieriJCP1982, WarrenPRL1998, SollichPRL1998, SollichAiCP2001}, e.g.\ a set $\{\xi_1, \cdots, \xi_M\}$ so that
\begin{equation}\label{eq:consistent-osmotic-pressure-weighted-densities}
  \beta p
  =
  \rho - \beta f^\mathrm{ex}
  + \rho \sum_{k=1}^M
  \xi_k \left( \frac{\partial \beta f^\mathrm{ex}}{\partial \xi_k} \right)_{V,T},
\end{equation}
with weighted densities adopting the form
\begin{equation*}
  \xi_k
  =
  \rho \sum_i x_i f_k(\sigma_i),
  %\rho \int d\mu(s),
\end{equation*}
where $f_k(\cdot)$ is the probability measure describing the size distribution.
In the limit of continuous distributions the weighted densities become integrals
\begin{equation*}
  \xi_k
  =
  \rho \int f_k(\sigma) d\mu(\sigma)
  %\rho \int d\mu(s),
\end{equation*}
introducing the probability measure $\mu(\sigma)$ for the molarities of particle species such that $\int d\mu(\sigma) = 1$.
%This reduces to the previous form for discrete mixtures if we set $\mu(s)$ to the counting measure, however in integral form we are free to extend the calculation to continuous mixtures.
With finite $M$ \eqref{eq:consistent-osmotic-pressure-weighted-densities} remains well-defined in this limit.

This concludes our summary of liquid state theory for homogeneous systems.
In subsqeuent sections we will review its extensions to inhomogeneous systems, with the purpose of introducing the main framework we will use for our treatment of correlations inside the homogeneous liquid in chapters \ref{chapter:morphometric-framework}, \ref{chapter:morphometric-applications} and \ref{chapter:resummation}.
